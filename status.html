<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Herdernacht Songwünsche - Status</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyApqXsW-bTblW66DVMTw4S-dsND92-wBFQ",
      authDomain: "herder-7dd17.firebaseapp.com",
      projectId: "herder-7dd17",
      storageBucket: "herder-7dd17.firebasestorage.app",
      messagingSenderId: "472463332211",
      appId: "1:472463332211:web:6b8ea4a8d1480792a62b06",
      measurementId: "G-HR07N6LXGN"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>
</head>
<body class="bg-gray-900 text-white min-h-screen p-6 flex flex-col items-center">

  <h1 class="text-3xl font-bold mb-6">🎵 Bisherige Songwünsche</h1>

  <div class="flex justify-end mb-4">
  <button onclick="loadWishes()" class="bg-blue-700 hover:bg-blue-800 px-4 py-2 rounded">
    🔄 Aktualisieren
  </button>
</div>

    <div class="flex space-x-4 mt-8">
    <button onclick="location.href='index.html'" class="bg-blue-600 px-5 py-2 rounded hover:bg-blue-700">⬅ Zur Startseite</button>
    <button onclick="location.href='admin.html'" class="bg-green-600 px-5 py-2 rounded hover:bg-green-700">🔒 Bearbeiten (Login)</button>
  </div>
<br>
  <div id="wunschListe" class="w-full max-w-3xl space-y-4"></div>


  <script>
  const wunschListe = document.getElementById("wunschListe");

  function renderWunsch(doc) {
    const data = doc.data();
    const div = document.createElement("div");
    div.className = "bg-gray-800 p-4 rounded shadow";

    const title = document.createElement("h2");
    title.className = "text-xl font-semibold";
    title.textContent = data.title + " — " + data.artist;
    div.appendChild(title);

    if (data.link) {
      const link = document.createElement("a");
      link.href = data.link;
      link.target = "_blank";
      link.rel = "noopener";
      link.className = "text-blue-400 hover:underline";
      link.textContent = "Link anhören";
      div.appendChild(link);
    }

    if (data.comment) {
      const comment = document.createElement("p");
      comment.className = "mt-2 italic text-gray-300";
      comment.textContent = "Kommentar: " + data.comment;
      div.appendChild(comment);
    }

    const status = document.createElement("p");
    status.className = "mt-2 font-semibold";

    let statusText = "Status: " + data.status.charAt(0).toUpperCase() + data.status.slice(1);

    if (data.status === "abgelehnt" && data.reason) {
      statusText = "Status: Abgelehnt: " + data.reason;
      status.className += " text-red-400";
    } else if (data.status === "gespielt") {
      statusText += " ✅";
    }

    status.textContent = statusText;
    div.appendChild(status);

    const votingDiv = document.createElement("div");
    votingDiv.className = "mt-3 flex items-center space-x-4";

    const upvoteBtn = document.createElement("button");
    const downvoteBtn = document.createElement("button");

    const voteKey = `vote_${doc.id}`;
    const alreadyVoted = localStorage.getItem(voteKey);

    upvoteBtn.textContent = `👍 (${data.upvotes || 0})`;
    upvoteBtn.className = "bg-green-600 px-3 py-1 rounded hover:bg-green-700";
    upvoteBtn.disabled = alreadyVoted !== null;
    if (upvoteBtn.disabled) upvoteBtn.classList.add("opacity-50", "cursor-not-allowed");

    upvoteBtn.onclick = async () => {
      if (localStorage.getItem(voteKey)) return;
      const newUp = (data.upvotes || 0) + 1;
      await db.collection("wuensche").doc(doc.id).update({ upvotes: newUp });
      localStorage.setItem(voteKey, "up");
      upvoteBtn.textContent = `👍 (${newUp})`;
      upvoteBtn.disabled = true;
      upvoteBtn.classList.add("opacity-50", "cursor-not-allowed");
    };

    downvoteBtn.textContent = `👎 (${data.downvotes || 0})`;
    downvoteBtn.className = "bg-red-600 px-3 py-1 rounded hover:bg-red-700";
    downvoteBtn.disabled = alreadyVoted !== null;
    if (downvoteBtn.disabled) downvoteBtn.classList.add("opacity-50", "cursor-not-allowed");

    downvoteBtn.onclick = async () => {
      if (localStorage.getItem(voteKey)) return;
      const newDown = (data.downvotes || 0) + 1;
      await db.collection("wuensche").doc(doc.id).update({ downvotes: newDown });
      localStorage.setItem(voteKey, "down");
      downvoteBtn.textContent = `👎 (${newDown})`;
      downvoteBtn.disabled = true;
      downvoteBtn.classList.add("opacity-50", "cursor-not-allowed");
    };

    votingDiv.appendChild(upvoteBtn);
    votingDiv.appendChild(downvoteBtn);
    div.appendChild(votingDiv);

    wunschListe.appendChild(div);
  }

  function loadWishes() {
    wunschListe.innerHTML = "";
    db.collection("wuensche")
      .orderBy("timestamp", "desc")
      .get()
      .then(snapshot => {
        snapshot.forEach(doc => renderWunsch(doc));
      });
  }

  // Starte mit einem Initial-Load
  loadWishes();
</script>


</body>
</html>
