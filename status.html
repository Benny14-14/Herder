<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Status ‚Äì Herdernacht Songw√ºnsche</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyApqXsW-bTblW66DVMTw4S-dsND92-wBFQ",
      authDomain: "herder-7dd17.firebaseapp.com",
      projectId: "herder-7dd17",
      storageBucket: "herder-7dd17.firebasestorage.app",
      messagingSenderId: "472463332211",
      appId: "1:472463332211:web:6b8ea4a8d1480792a62b06",
      measurementId: "G-HR07N6LXGN"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Votes in localStorage speichern, um mehrfaches Voten pro Ger√§t zu verhindern
    function getVotesFromStorage() {
      const votes = localStorage.getItem("votes");
      return votes ? JSON.parse(votes) : {};
    }
    function saveVotesToStorage(votes) {
      localStorage.setItem("votes", JSON.stringify(votes));
    }

    function updateVoteUI(id, upvotes, downvotes) {
      const upEl = document.getElementById("upcount-" + id);
      const downEl = document.getElementById("downcount-" + id);
      if (upEl) upEl.textContent = upvotes;
      if (downEl) downEl.textContent = downvotes;

      const votesLocal = getVotesFromStorage();
      const userVote = votesLocal[id] || null;

      const upBtn = document.getElementById("upvote-" + id);
      const downBtn = document.getElementById("downvote-" + id);

      if (userVote === "up") {
        upBtn.classList.add("bg-green-600");
        upBtn.classList.remove("bg-gray-700", "hover:bg-green-600");
        downBtn.classList.remove("bg-red-600");
        downBtn.classList.add("bg-gray-700", "hover:bg-red-600");
      } else if (userVote === "down") {
        downBtn.classList.add("bg-red-600");
        downBtn.classList.remove("bg-gray-700", "hover:bg-red-600");
        upBtn.classList.remove("bg-green-600");
        upBtn.classList.add("bg-gray-700", "hover:bg-green-600");
      } else {
        upBtn.classList.remove("bg-green-600");
        upBtn.classList.add("bg-gray-700", "hover:bg-green-600");
        downBtn.classList.remove("bg-red-600");
        downBtn.classList.add("bg-gray-700", "hover:bg-red-600");
      }
    }

    function renderWish(doc) {
      const data = doc.data();
      const id = doc.id;

      const div = document.createElement("div");
      div.className = "bg-gray-800 p-4 rounded shadow mb-4";

      const hasLink = data.link ? true : false;
      const reasonText = data.status.includes(":") ? `<p class="text-sm italic mt-1">Grund: ${data.status.split(":")[1]}</p>` : "";

      // Votes initialisieren falls nicht vorhanden
      if (typeof data.upvotes !== "number") data.upvotes = 0;
      if (typeof data.downvotes !== "number") data.downvotes = 0;

      // Lokale Votes holen
      const votesLocal = getVotesFromStorage();
      const userVote = votesLocal[id] || null;

      div.innerHTML = `
        <p class="text-lg font-semibold">${data.title} ‚Äì ${data.artist}</p>
        ${hasLink ? `<a href="${data.link}" class="text-blue-400 underline" target="_blank" rel="noopener noreferrer">üîó Link</a>` : ""}
        <div class="mt-2 flex items-center space-x-4">
          <button id="upvote-${id}" class="px-3 py-1 rounded cursor-pointer ${userVote === 'up' ? 'bg-green-600' : 'bg-gray-700 hover:bg-green-600'}">üëç <span id="upcount-${id}">${data.upvotes}</span></button>
          <button id="downvote-${id}" class="px-3 py-1 rounded cursor-pointer ${userVote === 'down' ? 'bg-red-600' : 'bg-gray-700 hover:bg-red-600'}">üëé <span id="downcount-${id}">${data.downvotes}</span></button>
        </div>
        <p class="mt-2 font-semibold">
          Status: <span class="${data.status.startsWith('abgelehnt') ? 'text-red-400' : 'text-green-400'}">
            ${data.status.charAt(0).toUpperCase() + data.status.slice(1)}
          </span>
        </p>
        ${reasonText}
      `;

      // Eventhandler Upvote
      div.querySelector(`#upvote-${id}`).onclick = () => {
        if (userVote === "up") return;
        const batch = db.batch();
        const ref = db.collection("wuensche").doc(id);

        if (userVote === "down") {
          batch.update(ref, { downvotes: data.downvotes - 1 });
          data.downvotes--;
        }
        batch.update(ref, { upvotes: data.upvotes + 1 });
        data.upvotes++;

        batch.commit().then(() => {
          votesLocal[id] = "up";
          saveVotesToStorage(votesLocal);
          updateVoteUI(id, data.upvotes, data.downvotes);
        });
      };

      // Eventhandler Downvote
      div.querySelector(`#downvote-${id}`).onclick = () => {
        if (userVote === "down") return;
        const batch = db.batch();
        const ref = db.collection("wuensche").doc(id);

        if (userVote === "up") {
          batch.update(ref, { upvotes: data.upvotes - 1 });
          data.upvotes--;
        }
        batch.update(ref, { downvotes: data.downvotes + 1 });
        data.downvotes++;

        batch.commit().then(() => {
          votesLocal[id] = "down";
          saveVotesToStorage(votesLocal);
          updateVoteUI(id, data.upvotes, data.downvotes);
        });
      };

      return div;
    }

    function loadWishes() {
      const container = document.getElementById("wishesContainer");
      db.collection("wuensche").orderBy("timestamp", "desc").onSnapshot(snapshot => {
        container.innerHTML = "";
        snapshot.forEach(doc => {
          const wishDiv = renderWish(doc);
          container.appendChild(wishDiv);
        });
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadWishes();

      document.getElementById("backBtn").onclick = () => {
        location.href = "index.html";
      };
    });
  </script>
</head>
<body class="bg-gray-900 text-white p-6 min-h-screen">
  <h1 class="text-2xl font-bold mb-6">üéµ Status ‚Äì Herdernacht Songw√ºnsche</h1>
  <button id="backBtn" class="mb-6 bg-blue-600 px-4 py-2 rounded hover:bg-blue-700">üîô Zur√ºck zur Startseite</button>

  <div id="wishesContainer" class="space-y-4"></div>
</body>
</html>
