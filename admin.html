<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel ‚Äì Herdernacht</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen p-6">

  <div class="max-w-6xl mx-auto">

    <h1 class="text-3xl font-bold mb-6">üõ† Admin Panel ‚Äì Songw√ºnsche</h1>

    <input
      type="text"
      id="filterInput"
      placeholder="Filtern nach Song oder User..."
      class="mb-4 w-full p-2 rounded bg-gray-700 text-white"
    />

    <div class="overflow-x-auto">
      <table class="min-w-full table-auto border-collapse border border-gray-700">
        <thead>
          <tr class="bg-gray-800 text-left">
            <th class="border border-gray-600 px-4 py-2">Song</th>
            <th class="border border-gray-600 px-4 py-2">User</th>
            <th class="border border-gray-600 px-4 py-2">Kommentar</th>
            <th class="border border-gray-600 px-4 py-2">Aktion</th>
          </tr>
        </thead>
        <tbody id="wuenscheTableBody">
          <tr><td colspan="4" class="text-center p-4">Lade Daten...</td></tr>
        </tbody>
      </table>
    </div>

  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyApqXsW-bTblW66DVMTw4S-dsND92-wBFQ",
      authDomain: "herder-7dd17.firebaseapp.com",
      projectId: "herder-7dd17",
      storageBucket: "herder-7dd17.firebasestorage.app",
      messagingSenderId: "472463332211",
      appId: "1:472463332211:web:6b8ea4a8d1480792a62b06",
      measurementId: "G-HR07N6LXGN"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const tableBody = document.getElementById("wuenscheTableBody");
    const filterInput = document.getElementById("filterInput");

    let wuenscheData = [];
    let wuenscheDocs = []; // Array f√ºr Dokument-IDs

    async function loadWuensche() {
      try {
        const snapshot = await db.collection("wuensche").get();

        if (snapshot.empty) {
          tableBody.innerHTML = `<tr><td colspan="4" class="text-center p-4">Keine W√ºnsche gefunden.</td></tr>`;
          return;
        }

        wuenscheData = snapshot.docs.map(doc => doc.data());
        wuenscheDocs = snapshot.docs.map(doc => doc.id);

        renderTable(wuenscheData);

      } catch (error) {
        tableBody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-red-500">Fehler beim Laden: ${error.message}</td></tr>`;
      }
    }

    function renderTable(data) {
      if (data.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="4" class="text-center p-4">Keine passenden Ergebnisse.</td></tr>`;
        return;
      }

      tableBody.innerHTML = data.map((wunsch, i) => `
        <tr class="border border-gray-700 hover:bg-gray-700">
          <td class="border border-gray-600 px-4 py-2">${escapeHtml(wunsch.song || "")}</td>
          <td class="border border-gray-600 px-4 py-2">${escapeHtml(wunsch.user || "")}</td>
          <td class="border border-gray-600 px-4 py-2">${escapeHtml(wunsch.kommentar || "")}</td>
          <td class="border border-gray-600 px-4 py-2 space-x-2">
            <button onclick="handleWunsch('${wuenscheDocs[i]}', true)" class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded">Annehmen</button>
            <button onclick="handleWunsch('${wuenscheDocs[i]}', false)" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded">Ablehnen</button>
          </td>
        </tr>
      `).join("");
    }

    async function handleWunsch(docId, accepted) {
      try {
        // Beispiel: Wunsch-Dokument l√∂schen oder Status setzen
        if (accepted) {
          // z.B. Status "angenommen" setzen
          await db.collection("wuensche").doc(docId).update({ status: "angenommen" });
          alert("Wunsch angenommen!");
        } else {
          // Wunsch l√∂schen
          await db.collection("wuensche").doc(docId).delete();
          alert("Wunsch abgelehnt und gel√∂scht!");
        }
        // Tabelle aktualisieren
        loadWuensche();
      } catch (error) {
        alert("Fehler: " + error.message);
      }
    }

    function escapeHtml(text) {
      if (!text) return "";
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    filterInput.addEventListener("input", () => {
      const filterValue = filterInput.value.toLowerCase();
      const filtered = wuenscheData.filter(wunsch => {
        const song = (wunsch.song || "").toLowerCase();
        const user = (wunsch.user || "").toLowerCase();
        return song.includes(filterValue) || user.includes(filterValue);
      });
      renderTable(filtered);
    });

    loadWuensche();
  </script>
</body>
</html>
