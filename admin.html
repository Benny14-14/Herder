<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin â€“ Herdernacht SongwÃ¼nsche</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyApqXsW-bTblW66DVMTw4S-dsND92-wBFQ",
      authDomain: "herder-7dd17.firebaseapp.com",
      projectId: "herder-7dd17",
      storageBucket: "herder-7dd17.firebasestorage.app",
      messagingSenderId: "472463332211",
      appId: "1:472463332211:web:6b8ea4a8d1480792a62b06",
      measurementId: "G-HR07N6LXGN"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>
</head>
<body class="bg-gray-900 text-white p-6">
  <h1 class="text-2xl font-bold mb-4">ðŸ”’ Adminbereich â€“ SongwÃ¼nsche verwalten</h1>

  <!-- Toggle fÃ¼r Zufallsdesign -->
  <div class="mb-6 flex items-center space-x-4">
    <label for="designToggle" class="text-lg">ðŸŽ¨ Zufallsdesign auf Startseite aktivieren:</label>
    <input type="checkbox" id="designToggle" class="h-6 w-12 rounded cursor-pointer" />
  </div>

  <button onclick="location.href='index.html'" class="mb-4 bg-blue-600 px-4 py-2 rounded hover:bg-blue-700">ðŸ”™ ZurÃ¼ck zur Startseite</button>

  <div class="mb-8">
    <h2 class="text-xl font-semibold mb-2">ðŸ†• Neue WÃ¼nsche</h2>
    <div id="newWishes" class="space-y-4"></div>
  </div>

  <div>
    <h2 class="text-xl font-semibold mb-2">âœ… Bearbeitete WÃ¼nsche</h2>
    <div id="processedWishes" class="space-y-4"></div>
  </div>

  <script>
    const newWishesDiv = document.getElementById("newWishes");
    const processedDiv = document.getElementById("processedWishes");
    const designToggle = document.getElementById("designToggle");

    const ablehnGruende = [
      "Unangemessen", "Passt nicht zur Playlist", "Zu laut", "Zu viel Bass", "Technisch problematisch"
    ];

    // Funktion fÃ¼r Dropdowns
    function createDropdown(options, selected, onchange) {
      const select = document.createElement("select");
      select.className = "bg-gray-800 p-1 text-white rounded border border-gray-600 ml-2";
      options.forEach(opt => {
        const o = document.createElement("option");
        o.value = opt;
        o.textContent = opt;
        if (opt === selected) o.selected = true;
        select.appendChild(o);
      });
      select.onchange = onchange;
      return select;
    }

    // WÃ¼nsche rendern
    function renderWish(doc) {
      const data = doc.data();
      const div = document.createElement("div");
      div.className = "bg-gray-800 p-4 rounded shadow";
      let statusText = data.status;

      if (data.status && data.status.startsWith("abgelehnt:")) {
        statusText = "Abgelehnt: " + data.status.split(":")[1].trim();
      }

      div.innerHTML = `
        <p><strong>${data.title}</strong> â€“ ${data.artist}</p>
        ${data.link ? `<a href="${data.link}" class="text-blue-400 underline" target="_blank">ðŸ”— Link</a>` : ""}
        ${data.reason ? `<p class="text-sm italic mt-1">${data.reason}</p>` : ""}
        <p class="mt-2 font-semibold">Status: ${statusText}</p>
      `;

      if (data.status === "offen") {
        const acceptBtn = document.createElement("button");
        acceptBtn.textContent = "âœ… Annehmen";
        acceptBtn.className = "bg-green-600 px-2 py-1 rounded mr-2 mt-2 hover:bg-green-700";
        acceptBtn.onclick = () => db.collection("wuensche").doc(doc.id).update({ status: "angenommen" });

        const declineBtn = document.createElement("button");
        declineBtn.textContent = "âŒ Ablehnen";
        declineBtn.className = "bg-red-600 px-2 py-1 rounded mt-2 hover:bg-red-700";

        const reasonSelect = createDropdown(["Ablehnungsgrund wÃ¤hlen", ...ablehnGruende], "Ablehnungsgrund wÃ¤hlen", e => {
          if (e.target.value !== "Ablehnungsgrund wÃ¤hlen") {
            db.collection("wuensche").doc(doc.id).update({ status: `abgelehnt: ${e.target.value}` });
          }
        });

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "ðŸ—‘ï¸ LÃ¶schen";
        deleteBtn.className = "bg-gray-600 px-2 py-1 rounded ml-2 mt-2 hover:bg-gray-700";
        deleteBtn.onclick = () => db.collection("wuensche").doc(doc.id).delete();

        div.appendChild(acceptBtn);
        div.appendChild(declineBtn);
        div.appendChild(reasonSelect);
        div.appendChild(deleteBtn);

        newWishesDiv.appendChild(div);
      } else {
        const statusSelect = createDropdown(["angenommen", "gespielt", "abgelehnt", "offen"], data.status.split(":")[0], e => {
          db.collection("wuensche").doc(doc.id).update({ status: e.target.value });
        });

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "ðŸ—‘ï¸ LÃ¶schen";
        deleteBtn.className = "bg-gray-600 px-2 py-1 rounded ml-2 hover:bg-gray-700";
        deleteBtn.onclick = () => db.collection("wuensche").doc(doc.id).delete();

        div.appendChild(statusSelect);
        div.appendChild(deleteBtn);
        processedDiv.appendChild(div);
      }
    }

    // Laden der Konfiguration fÃ¼r Zufallsdesign
    function loadDesignConfig() {
      db.collection("config").doc("designMode").get().then(docSnap => {
        if (docSnap.exists) {
          const enabled = docSnap.data().enabled;
          designToggle.checked = enabled;
        } else {
          // Wenn config noch nicht existiert, Standard = false
          designToggle.checked = false;
        }
      });
    }

    // Speichern der Konfiguration bei Umschalten
    designToggle.addEventListener("change", () => {
      db.collection("config").doc("designMode").set({ enabled: designToggle.checked });
    });

    // Daten aus Firestore holen
    db.collection("wuensche").orderBy("timestamp", "desc").onSnapshot(snapshot => {
      newWishesDiv.innerHTML = "";
      processedDiv.innerHTML = "";
      snapshot.forEach(doc => renderWish(doc));
    });

    loadDesignConfig();
  </script>
</body>
</html>
