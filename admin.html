<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel â€“ Herdernacht</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen p-6 flex flex-col items-center justify-center">

  <!-- Login Container -->
  <div id="loginContainer" class="bg-gray-800 p-8 rounded shadow max-w-md w-full">
    <h1 class="text-3xl font-bold mb-6 text-center">ðŸ”’ Login</h1>
    <p id="errorMsg" class="mb-4 text-red-500 text-center hidden"></p>
    <form id="loginForm" class="space-y-4">
      <label class="block">
        Benutzername:
        <input
          type="text"
          id="usernameInput"
          class="w-full mt-1 p-2 rounded bg-gray-700 text-white"
          autocomplete="username"
          required
        />
      </label>
      <label class="block">
        Passwort:
        <input
          type="password"
          id="passwordInput"
          class="w-full mt-1 p-2 rounded bg-gray-700 text-white"
          autocomplete="current-password"
          required
        />
      </label>
      <button
        type="submit"
        class="w-full bg-blue-600 hover:bg-blue-700 py-2 rounded text-white font-semibold"
      >
        Anmelden
      </button>
    </form>
  </div>

  <!-- Admin Content Container (versteckt, bis login erfolgt) -->
  <div id="adminContainer" class="max-w-6xl mx-auto w-full hidden flex-col">
    <header class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold">ðŸ›  Admin Panel</h1>
      <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded">Abmelden</button>
    </header>

    <section id="content">
      <p>Lade Daten...</p>
    </section>
  </div>

  <script>
    // ==========================
    // Firebase konfigurieren
    // ==========================
    const firebaseConfig = {
      apiKey: "AIzaSyApqXsW-bTblW66DVMTw4S-dsND92-wBFQ",
      authDomain: "herder-7dd17.firebaseapp.com",
      projectId: "herder-7dd17",
      storageBucket: "herder-7dd17.firebasestorage.app",
      messagingSenderId: "472463332211",
      appId: "1:472463332211:web:6b8ea4a8d1480792a62b06",
      measurementId: "G-HR07N6LXGN"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ==========================
    // Element-Referenzen
    // ==========================
    const loginContainer = document.getElementById("loginContainer");
    const adminContainer = document.getElementById("adminContainer");
    const loginForm = document.getElementById("loginForm");
    const errorMsg = document.getElementById("errorMsg");
    const usernameInput = document.getElementById("usernameInput");
    const passwordInput = document.getElementById("passwordInput");
    const logoutBtn = document.getElementById("logoutBtn");
    const content = document.getElementById("content");

    // ==========================
    // Funktionen um Anzeige zu wechseln
    // ==========================
    function showAdminPanel(username) {
      loginContainer.classList.add("hidden");
      adminContainer.classList.remove("hidden");
      content.innerHTML = `<p>Willkommen, <strong>${username}</strong>!</p><p>Hier kannst du jetzt deine Admin-Daten laden und bearbeiten.</p>`;
      loadWuensche();
    }

    function showLogin() {
      loginContainer.classList.remove("hidden");
      adminContainer.classList.add("hidden");
      errorMsg.classList.add("hidden");
      loginForm.reset();
    }

    // ==========================
    // PrÃ¼fen, ob User eingeloggt ist (lokal)
    // ==========================
    const loggedInUserId = localStorage.getItem("loggedInUserId");
    const loggedInUsername = localStorage.getItem("loggedInUsername");

    if (loggedInUserId && loggedInUsername) {
      // Wenn eingeloggt: Admin-Bereich zeigen
      showAdminPanel(loggedInUsername);
    } else {
      // Wenn nicht eingeloggt: Login-Form zeigen (keine Weiterleitung)
      showLogin();
    }

    // ==========================
    // Login-Formular Event
    // ==========================
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const username = usernameInput.value.trim();
      const password = passwordInput.value;

      errorMsg.classList.add("hidden");
      errorMsg.textContent = "";

      try {
        const querySnapshot = await db.collection("users").where("username", "==", username).get();

        if (querySnapshot.empty) {
          throw new Error("Benutzername nicht gefunden");
        }

        const userDoc = querySnapshot.docs[0];
        const userData = userDoc.data();

        if (userData.passwort !== password) {
          throw new Error("Falsches Passwort");
        }

        // Login erfolgreich: lokal speichern
        localStorage.setItem("loggedInUserId", userDoc.id);
        localStorage.setItem("loggedInUsername", username);

        showAdminPanel(username);

      } catch (error) {
        errorMsg.textContent = error.message;
        errorMsg.classList.remove("hidden");
      }
    });

    // ==========================
    // Logout Event
    // ==========================
    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem("loggedInUserId");
      localStorage.removeItem("loggedInUsername");
      showLogin();
    });

    // ==========================
    // Beispiel: WÃ¼nsche laden
    // ==========================
    async function loadWuensche() {
      content.innerHTML += "<p>Lade WÃ¼nsche...</p>";

      try {
        const snapshot = await db.collection("wuensche").get();
        if (snapshot.empty) {
          content.innerHTML += "<p>Keine WÃ¼nsche gefunden.</p>";
          return;
        }

        let html = `<h2 class="text-xl font-bold mt-6 mb-2">SongwÃ¼nsche</h2><ul class="list-disc ml-6">`;
        snapshot.forEach(doc => {
          const data = doc.data();
          html += `<li><strong>${data.song || "Unbekannter Song"}</strong> von ${data.user || "Unbekannter User"}</li>`;
        });
        html += "</ul>";
        content.innerHTML += html;

      } catch (error) {
        content.innerHTML += `<p class="text-red-500">Fehler beim Laden der WÃ¼nsche: ${error.message}</p>`;
      }
    }
  </script>
</body>
</html>
