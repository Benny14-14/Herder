<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Herdernacht SongwÃ¼nsche - Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyApqXsW-bTblW66DVMTw4S-dsND92-wBFQ",
      authDomain: "herder-7dd17.firebaseapp.com",
      projectId: "herder-7dd17",
      storageBucket: "herder-7dd17.firebasestorage.app",
      messagingSenderId: "472463332211",
      appId: "1:472463332211:web:6b8ea4a8d1480792a62b06",
      measurementId: "G-HR07N6LXGN"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Admin-Passwort hier anpassen:
    const ADMIN_PASSWORD = "herder2025"; // <- bitte anpassen

    // Ablehn-GrÃ¼nde zur Auswahl
    const REJECT_REASONS = [
      "Unangemessen",
      "Passt nicht zur Playlist",
      "Zu laut",
      "Zu viel Bass",
      "Sonstiges"
    ];
  </script>
</head>
<body class="bg-gray-900 text-white min-h-screen p-6 flex flex-col items-center">

  <!-- LOGIN -->
  <div id="loginContainer" class="max-w-md w-full bg-gray-800 p-6 rounded shadow-lg">
    <h2 class="text-2xl font-bold mb-4 text-center">Admin Login</h2>
    <form id="loginForm" class="space-y-4">
      <input type="password" id="password" placeholder="Admin Passwort" required autocomplete="off" class="w-full p-2 rounded text-black" />
      <button type="submit" class="bg-green-600 px-4 py-2 rounded hover:bg-green-700 w-full">Anmelden</button>
    </form>
    <p id="loginError" class="text-red-500 mt-2 text-center"></p>
  </div>

  <!-- ADMIN-BEREICH -->
  <div id="adminContent" class="hidden w-full max-w-6xl flex flex-col space-y-6">

    <div class="flex justify-between items-center">
      <h1 class="text-3xl font-bold mb-2">ðŸŽµ Adminbereich</h1>
      <button id="logoutBtn" class="bg-red-600 px-4 py-2 rounded hover:bg-red-700">Logout</button>
    </div>

    <!-- Filter -->
    <div class="bg-gray-800 p-4 rounded flex flex-wrap gap-4 items-center">
      <label>
        Sortieren nach:
        <select id="sortSelect" class="ml-2 rounded p-1 bg-gray-700 text-white">
          <option value="timestamp_desc">Neueste zuerst</option>
          <option value="timestamp_asc">Ã„lteste zuerst</option>
          <option value="title_asc">Songtitel A-Z</option>
          <option value="title_desc">Songtitel Z-A</option>
          <option value="artist_asc">Interpret A-Z</option>
          <option value="artist_desc">Interpret Z-A</option>
          <option value="link_yes">Hat Link</option>
          <option value="link_no">Kein Link</option>
        </select>
      </label>
      <label>
        Filter Status:
        <select id="statusFilter" class="ml-2 rounded p-1 bg-gray-700 text-white">
          <option value="offen">Neue WÃ¼nsche</option>
          <option value="bearbeitet">Bearbeitete WÃ¼nsche</option>
          <option value="alle" selected>Alle</option>
        </select>
      </label>
    </div>

    <!-- Neue WÃ¼nsche Tabelle -->
    <div>
      <h2 class="text-xl font-semibold mb-2">Neue WÃ¼nsche (Status: offen)</h2>
      <table class="min-w-full table-auto border-collapse border border-gray-600">
        <thead>
          <tr class="bg-gray-700 text-left">
            <th class="border border-gray-600 p-2">Songtitel</th>
            <th class="border border-gray-600 p-2">Interpret</th>
            <th class="border border-gray-600 p-2">Link</th>
            <th class="border border-gray-600 p-2">Kommentar</th>
            <th class="border border-gray-600 p-2">Status Ã¤ndern</th>
            <th class="border border-gray-600 p-2">LÃ¶schen</th>
          </tr>
        </thead>
        <tbody id="offenTbody"></tbody>
      </table>
    </div>

    <!-- Bearbeitete WÃ¼nsche Tabelle -->
    <div>
      <h2 class="text-xl font-semibold mb-2">Bearbeitete WÃ¼nsche (Status: angenommen / abgelehnt / gespielt)</h2>
      <table class="min-w-full table-auto border-collapse border border-gray-600">
        <thead>
          <tr class="bg-gray-700 text-left">
            <th class="border border-gray-600 p-2">Songtitel</th>
            <th class="border border-gray-600 p-2">Interpret</th>
            <th class="border border-gray-600 p-2">Link</th>
            <th class="border border-gray-600 p-2">Kommentar</th>
            <th class="border border-gray-600 p-2">Status</th>
            <th class="border border-gray-600 p-2">Ablehn-Grund</th>
            <th class="border border-gray-600 p-2">Aktionen</th>
          </tr>
        </thead>
        <tbody id="bearbeitetTbody"></tbody>
      </table>
    </div>

  </div>

  <script>
    const loginContainer = document.getElementById("loginContainer");
    const adminContent = document.getElementById("adminContent");
    const loginForm = document.getElementById("loginForm");
    const loginError = document.getElementById("loginError");
    const logoutBtn = document.getElementById("logoutBtn");
    const offenTbody = document.getElementById("offenTbody");
    const bearbeitetTbody = document.getElementById("bearbeitetTbody");
    const sortSelect = document.getElementById("sortSelect");
    const statusFilter = document.getElementById("statusFilter");

    // Einfacher Loginstatus mit SessionStorage
    function isLoggedIn() {
      return sessionStorage.getItem("adminLoggedIn") === "true";
    }
    function setLoggedIn(status) {
      sessionStorage.setItem("adminLoggedIn", status ? "true" : "false");
    }

    // WÃ¼nsche zwischenspeichern
    let wuensche = [];

    // Filter & Sort Funktion
    function filterAndSort() {
      let filtered = wuensche;

      // Filter Status
      const statusVal = statusFilter.value;
      if(statusVal === "offen"){
        filtered = filtered.filter(w => w.status === "offen");
      } else if(statusVal === "bearbeitet"){
        filtered = filtered.filter(w => ["angenommen","abgelehnt","gespielt"].includes(w.status));
      }

      // Sortieren
      switch(sortSelect.value){
        case "timestamp_desc":
          filtered.sort((a,b) => b.timestamp?.toMillis() - a.timestamp?.toMillis());
          break;
        case "timestamp_asc":
          filtered.sort((a,b) => a.timestamp?.toMillis() - b.timestamp?.toMillis());
          break;
        case "title_asc":
          filtered.sort((a,b) => a.title.localeCompare(b.title));
          break;
        case "title_desc":
          filtered.sort((a,b) => b.title.localeCompare(a.title));
          break;
        case "artist_asc":
          filtered.sort((a,b) => a.artist.localeCompare(b.artist));
          break;
        case "artist_desc":
          filtered.sort((a,b) => b.artist.localeCompare(a.artist));
          break;
        case "link_yes":
          filtered = filtered.filter(w => w.link && w.link.trim() !== "");
          break;
        case "link_no":
          filtered = filtered.filter(w => !w.link || w.link.trim() === "");
          break;
      }

      return filtered;
    }

    // Anzeige leeren
    function clearTables(){
      offenTbody.innerHTML = "";
      bearbeitetTbody.innerHTML = "";
    }

    // Ablehnen-Dialog
    function showRejectReasonPrompt(currentReason){
      return new Promise(resolve => {
        const reason = prompt("Ablehn-Grund eingeben (optional):", currentReason || "");
        resolve(reason);
      });
    }

    // Status Ã¤ndern
    async function changeStatus(docId, newStatus, oldStatus, currentRejectReason) {
      if(newStatus === oldStatus) return;

      if(newStatus === "abgelehnt"){
        // Grund abfragen
        const reason = await showRejectReasonPrompt(currentRejectReason);
        await db.collection("wuensche").doc(docId).update({
          status: newStatus,
          rejectReason: reason || ""
        });
      } else {
        // Status Ã¤ndern, Grund entfernen wenn nicht abgelehnt
        await db.collection("wuensche").doc(docId).update({
          status: newStatus,
          rejectReason: ""
        });
      }
    }

    // LÃ¶schen
    async function deleteWunsch(docId){
      if(confirm("Wirklich lÃ¶schen?")){
        await db.collection("wuensche").doc(docId).delete();
      }
    }

    // Zeige alle WÃ¼nsche in Tabellen
    function renderAll() {
      clearTables();

      const filtered = filterAndSort();

      filtered.forEach(wunsch => {
        const tr = document.createElement("tr");
        tr.className = "border border-gray-600";

        // Hilfsfunktion fÃ¼r Link-Cell
        const createLinkCell = (link) => {
          const td = document.createElement("td");
          td.className = "border border-gray-600 p-2";
          if(link && link.trim() !== ""){
            const a = document.createElement("a");
            a.href = link;
            a.target = "_blank";
            a.rel = "noopener";
            a.className = "text-blue-400 hover:underline";
            a.textContent = "Link";
            td.appendChild(a);
          } else {
            td.textContent = "-";
          }
          return td;
        };

        // Hilfsfunktion fÃ¼r Kommentar-Cell
        const createCommentCell = (comment) => {
          const td = document.createElement("td");
          td.className = "border border-gray-600 p-2 italic text-gray-300";
          td.textContent = comment || "-";
          return td;
        };

        // Bei neuen WÃ¼nschen (offen)
        if(wunsch.status === "offen"){
          // Titel
          const tdTitle = document.createElement("td");
          tdTitle.className = "border border-gray-600 p-2";
          tdTitle.textContent = wunsch.title;
          tr.appendChild(tdTitle);

          // Interpret
          const tdArtist = document.createElement("td");
          tdArtist.className = "border border-gray-600 p-2";
          tdArtist.textContent = wunsch.artist;
          tr.appendChild(tdArtist);

          // Link
          tr.appendChild(createLinkCell(wunsch.link));

          // Kommentar
          tr.appendChild(createCommentCell(wunsch.comment));

          // Status Ã¤ndern (Dropdown)
          const tdStatus = document.createElement("td");
          tdStatus.className = "border border-gray-600 p-2";

          const selectStatus = document.createElement("select");
          selectStatus.className = "bg-gray-700 text-white rounded p-1 w-full";
          ["offen","angenommen","abgelehnt","gespielt"].forEach(statusOpt => {
            const option = document.createElement("option");
            option.value = statusOpt;
            option.textContent = statusOpt.charAt(0).toUpperCase() + statusOpt.slice(1);
            if(statusOpt === wunsch.status) option.selected = true;
            selectStatus.appendChild(option);
          });

          selectStatus.onchange = () => {
            changeStatus(wunsch.id, selectStatus.value, wunsch.status, wunsch.rejectReason).catch(console.error);
          };

          tdStatus.appendChild(selectStatus);
          tr.appendChild(tdStatus);

          // LÃ¶schen Button
          const tdDelete = document.createElement("td");
          tdDelete.className = "border border-gray-600 p-2 text-center";
          const btnDelete = document.createElement("button");
          btnDelete.className = "bg-red-600 px-3 py-1 rounded hover:bg-red-700";
          btnDelete.textContent = "LÃ¶schen";
          btnDelete.onclick = () => deleteWunsch(wunsch.id).catch(console.error);
          tdDelete.appendChild(btnDelete);
          tr.appendChild(tdDelete);

          offenTbody.appendChild(tr);

        } else {
          // Bearbeitete WÃ¼nsche

          // Titel
          const tdTitle = document.createElement("td");
          tdTitle.className = "border border-gray-600 p-2";
          tdTitle.textContent = wunsch.title;
          tr.appendChild(tdTitle);

          // Interpret
          const tdArtist = document.createElement("td");
          tdArtist.className = "border border-gray-600 p-2";
          tdArtist.textContent = wunsch.artist;
          tr.appendChild(tdArtist);

          // Link
          tr.appendChild(createLinkCell(wunsch.link));

          // Kommentar
          tr.appendChild(createCommentCell(wunsch.comment));

          // Status
          const tdStatus = document.createElement("td");
          tdStatus.className = "border border-gray-600 p-2 font-semibold";
          tdStatus.textContent = wunsch.status.charAt(0).toUpperCase() + wunsch.status.slice(1);
          tr.appendChild(tdStatus);

          // Ablehn-Grund
          const tdReject = document.createElement("td");
          tdReject.className = "border border-gray-600 p-2 italic text-red-500";
          tdReject.textContent = wunsch.status === "abgelehnt" ? (wunsch.rejectReason || "-") : "-";
          tr.appendChild(tdReject);

          // Aktionen
          const tdActions = document.createElement("td");
          tdActions.className = "border border-gray-600 p-2 space-x-2";

          // Status Ã¤ndern (Dropdown)
          const selectStatus = document.createElement("select");
          selectStatus.className = "bg-gray-700 text-white rounded p-1";
          ["offen","angenommen","abgelehnt","gespielt"].forEach(statusOpt => {
            const option = document.createElement("option");
            option.value = statusOpt;
            option.textContent = statusOpt.charAt(0).toUpperCase() + statusOpt.slice(1);
            if(statusOpt === wunsch.status) option.selected = true;
            selectStatus.appendChild(option);
          });
          selectStatus.onchange = () => {
            changeStatus(wunsch.id, selectStatus.value, wunsch.status, wunsch.rejectReason).catch(console.error);
          };
          tdActions.appendChild(selectStatus);

          // LÃ¶schen Button
          const btnDelete = document.createElement("button");
          btnDelete.className = "bg-red-600 px-3 py-1 rounded hover:bg-red-700";
          btnDelete.textContent = "LÃ¶schen";
          btnDelete.onclick = () => deleteWunsch(wunsch.id).catch(console.error);
          tdActions.appendChild(btnDelete);

          tr.appendChild(tdActions);

          bearbeitetTbody.appendChild(tr);
        }
      });
    }

    // WÃ¼nsche aus Firestore laden
    function loadWuensche() {
      db.collection("wuensche").orderBy("timestamp", "desc").onSnapshot(snapshot => {
        wuensche = snapshot.docs.map(doc => {
          return {
            id: doc.id,
            ...doc.data()
          };
        });
        renderAll();
      });
    }

    // Login-Handling
    loginForm.addEventListener("submit", e => {
      e.preventDefault();
      loginError.textContent = "";
      const pw = document.getElementById("password").value;
      if(pw === ADMIN_PASSWORD){
        setLoggedIn(true);
        showAppropriateView();
        loginForm.reset();
        loadWuensche();
      } else {
        loginError.textContent = "Falsches Passwort!";
      }
    });

    logoutBtn.addEventListener("click", () => {
      setLoggedIn(false);
      showAppropriateView();
    });

    // Filter & Sort Events
    sortSelect.addEventListener("change", renderAll);
    statusFilter.addEventListener("change", renderAll);

    // Sichtbarkeit steuern
    function showAppropriateView(){
      if(isLoggedIn()){
        loginContainer.classList.add("hidden");
        adminContent.classList.remove("hidden");
      } else {
        loginContainer.classList.remove("hidden");
        adminContent.classList.add("hidden");
      }
    }

    // Beim Laden prÃ¼fen
    showAppropriateView();
  </script>

</body>
</html>
