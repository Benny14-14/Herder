<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel â€“ Herdernacht</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen p-6">

  <div class="max-w-6xl mx-auto">

    <h1 class="text-3xl font-bold mb-6">ðŸ›  Admin Panel â€“ SongwÃ¼nsche</h1>

    <input
      type="text"
      id="filterInput"
      placeholder="Filtern nach Song oder User..."
      class="mb-4 w-full p-2 rounded bg-gray-700 text-white"
    />

    <div class="overflow-x-auto">
      <table class="min-w-full table-auto border-collapse border border-gray-700">
        <thead>
          <tr class="bg-gray-800 text-left">
            <th class="border border-gray-600 px-4 py-2">Zeit</th>
            <th class="border border-gray-600 px-4 py-2">Song</th>
            <th class="border border-gray-600 px-4 py-2">User</th>
            <th class="border border-gray-600 px-4 py-2">Kommentar</th>
          </tr>
        </thead>
        <tbody id="wuenscheTableBody">
          <tr><td colspan="4" class="text-center p-4">Lade Daten...</td></tr>
        </tbody>
      </table>
    </div>

  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyApqXsW-bTblW66DVMTw4S-dsND92-wBFQ",
      authDomain: "herder-7dd17.firebaseapp.com",
      projectId: "herder-7dd17",
      storageBucket: "herder-7dd17.firebasestorage.app",
      messagingSenderId: "472463332211",
      appId: "1:472463332211:web:6b8ea4a8d1480792a62b06",
      measurementId: "G-HR07N6LXGN"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const tableBody = document.getElementById("wuenscheTableBody");
    const filterInput = document.getElementById("filterInput");

    let wuenscheData = [];

    async function loadWuensche() {
      try {
        const snapshot = await db.collection("wuensche").get();

        if (snapshot.empty) {
          tableBody.innerHTML = `<tr><td colspan="4" class="text-center p-4">Keine WÃ¼nsche gefunden.</td></tr>`;
          return;
        }

        wuenscheData = snapshot.docs.map(doc => doc.data());
        renderTable(wuenscheData);

      } catch (error) {
        tableBody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-red-500">Fehler beim Laden: ${error.message}</td></tr>`;
      }
    }

    function renderTable(data) {
      if (data.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="4" class="text-center p-4">Keine passenden Ergebnisse.</td></tr>`;
        return;
      }

      tableBody.innerHTML = data.map(wunsch => {
        let zeitStr = "";
        if (wunsch.zeit && wunsch.zeit.toDate) {
          const date = wunsch.zeit.toDate();
          zeitStr = date.toLocaleString("de-DE", {
            day: "2-digit",
            month: "2-digit",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          });
        }

        return `
          <tr class="border border-gray-700 hover:bg-gray-700">
            <td class="border border-gray-600 px-4 py-2">${escapeHtml(zeitStr)}</td>
            <td class="border border-gray-600 px-4 py-2">${escapeHtml(wunsch.song || "")}</td>
            <td class="border border-gray-600 px-4 py-2">${escapeHtml(wunsch.user || "")}</td>
            <td class="border border-gray-600 px-4 py-2">${escapeHtml(wunsch.kommentar || "")}</td>
          </tr>
        `;
      }).join("");
    }

    function escapeHtml(text) {
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    filterInput.addEventListener("input", () => {
      const filterValue = filterInput.value.toLowerCase();
      const filtered = wuenscheData.filter(wunsch => {
        const song = (wunsch.song || "").toLowerCase();
        const user = (wunsch.user || "").toLowerCase();
        return song.includes(filterValue) || user.includes(filterValue);
      });
      renderTable(filtered);
    });

    loadWuensche();
  </script>
</body>
</html>
